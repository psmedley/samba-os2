# Warning! This file is autogenerated by salsa pipeline bot. Any change made
# over this document will be lost. Customization and changes must be made over
# the template yaml.
variables:
  DEBFULLNAME: "Salsa Pipeline"
  DEBEMAIL: "<salsa-pipeline@debian.org>"
  DEBIAN_FRONTEND: noninteractive
  WORKING_DIR: ./debian/output

stages:
  - build
  - test

image: debian:unstable

build package:
  stage: build
  image: registry.salsa.debian.org/salsa-ci-team/images/gbp
  services:
    - docker:dind
  artifacts:
    expire_in: 180 day
    name: "$CI_BUILD_NAME"
    paths:
        - ${WORKING_DIR}/
  script:
    - gbp pull --ignore-branch --pristine-tar --track-missing
    - gbp buildpackage --git-ignore-branch --git-export-dir=${WORKING_DIR} --git-builder='docker-build.sh registry.salsa.debian.org/salsa-ci-team/images/dockerbuilder'

run autopkgtest:
  stage: test
  image: registry.salsa.debian.org/salsa-ci-team/images/autopkgtest
  script:
    - eatmydata autopkgtest -U ${WORKING_DIR}/*.deb -- null

run lintian:
  stage: test
  image: registry.salsa.debian.org/salsa-ci-team/images/lintian
  script:
    - lintian -iI ${WORKING_DIR}/*.changes

run reprotest:
  stage: test
  image: registry.salsa.debian.org/salsa-ci-team/images/reprotest
  artifacts:
    name: "$CI_BUILD_NAME"
    expire_in: 180 day
    paths:
      - ./reprotest.log
    when: always
  script:
    - apt-get update
    - eatmydata apt-get build-dep -y .
    - export DEB_BUILD_OPTIONS=nocheck
    - eatmydata reprotest --no-diffoscope --min-cpus $(nproc --all) . -- null &> reprotest.log

run piuparts:
  stage: test
  image: registry.salsa.debian.org/sathieu/images/piuparts
  services:
    - docker:dind
  script:
    - CHROOT_PATH=/tmp/debian-unstable
    - CONTAINER_ID=$(docker run --rm -d debian:unstable sleep infinity)
    - docker exec ${CONTAINER_ID} bash -c "apt-get update && apt-get install eatmydata -y"
    - mkdir -p ${CHROOT_PATH}
    - docker export ${CONTAINER_ID} | tar -C ${CHROOT_PATH} -xf -
    - mknod -m 666 ${CHROOT_PATH}/dev/urandom c 1 9
    - mkdir -p ${CHROOT_PATH}/etc-target/apt/sources.list.d ${CHROOT_PATH}/etc-target/apt/preferences.d
    - cp -aTv /etc/apt/sources.list.d  ${CHROOT_PATH}/etc-target/apt/sources.list.d
    - cp -aTv /etc/apt/preferences.d  ${CHROOT_PATH}/etc-target/apt/preferences.d
    - piuparts --scriptsdir /etc/piuparts/scripts --allow-database --warn-on-leftovers-after-purge --hard-link -e ${CHROOT_PATH} ${WORKING_DIR}/*.deb
# End of include
#################################### Below starts the local customization ###################################
before_script:
  - echo 'deb http://deb.debian.org/debian experimental main' > /etc/apt/sources.list.d/experimental.list
  - "echo 'Package: ldb-tools libldb* python*-ldb*\nPin: release a=experimental\nPin-Priority: 500' > /etc/apt/preferences.d/experimental.pref"
